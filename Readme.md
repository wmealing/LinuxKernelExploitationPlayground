#Linux Kernel Exploitation#


This repository is modification of the "Fuzion24/AndroidKernelExploitationPlayground" exploit playground.  I got tired of trying to figure out what was wrong between android, qemu, version releases, android-studio and the rest of the crap that was required to make it work.. so here we are.

Each folder should have it's own challenge in the form of a loadable kernel module, it's own solution - code that will be executed from userspace to take advantage of the vulnerability (usually to gain us root), and a bit of a writeup about the vulnerability and the exploit.  

I am hoping that this will serve as a jumpstart for people to get started with kernel exploitation as well as a learning exercise for myself.  Feel free to fork and submit pull reqs for new challenges, documentations, etc..  I have not tested these yet, but as I complete them I'll update.


## Build the exploitable kernel.

##Linux
```
git clone https://github.com/torvalds/linux.git
```


## Patch the kernel.

The patch we are applying to our test kernel enables debugging symbols and builds our vulnerabilities into the kernel tree.

```
git clone https://github.com/wmealing/LinuxKernelExploitationPlayground.git kernel_exploit_challenge
cd linux &&  git checkout origin/linux-4.15.y
patch -p1 < ../kernel_exploit_challenges/kernel_build/debug_symbols_and_challenges-v4.15-rc2.patch && \
cd .. && ln -s $(pwd)/kernel_exploit_challenges/ linux/drivers/vulnerabilities
```

### Build the Kernel
```
cd linux && make defconfig && make bzImage -j8
```

This will probably build whatever defaults for the arch your currently running it on, it may or may not work for arm cpus, ive only tested it for x86, if you know a better way then do tell me.

### Boot and run the kernel.

From this point you can boot and run it however, you want however I use an tool that I wrote called re-produca which whips up a small initrd system

1) Using standard qemu with an existing disk image from your distro of choice.  This way you can get a distribution with tools that you are comfortable with
and a more familiar interface. 


```
qemu-system-x86_64 \
	-smp 4 \
	-kernel ./linux/arch/x86/boot/bzImage  \
        -drive file=/var/lib/libvirt/images/fedora-27.qcow2
```
For those with a more graphical bent, virt-manager allows for specification of a kernel bzImage and kernel-args which essentially achieves the same functionality.


2) Using reproduca

```
git clone https://github.com/wmealing/reproduca.git
cd reproduca

ln -s ../linux-stable/ linux 
make
```

This will build a sample simple exploit in TEMPLATE-EXPLOIT, you should copy this to a new name for your needs and the output will be:

```
[wmealing@linux re-produca]$ make
make -C TEMPLATE-EXPLOIT
make[1]: Entering directory '/home/wmealing/Source/re-produca/TEMPLATE-EXPLOIT'
cc -Wall -Werror -pthread -static reproducer.c -o reproducer
make[1]: Leaving directory '/home/wmealing/Source/re-produca/TEMPLATE-EXPLOIT'
cp TEMPLATE-EXPLOIT/reproducer initramfs/tmp/reproducer
cd initramfs ; find . -print0 |\
	cpio --null -ov --format=newc |\
	gzip --fast > ../initramfs-busybox-x64.cpio.gz
.
./bin
./bin/addgroup
./bin/adduser
./bin/ash
./bin/base64
./bin/cat
./bin/catv
./bin/chattr
./bin/chgrp
./bin/chmod
./bin/chown
./bin/cp
./bin/cpio
./bin/cttyhack
./bin/date
./bin/dd
./bin/delgroup
./bin/deluser
./bin/df
./bin/dmesg
./bin/dnsdomainname
./bin/dumpkmap
./bin/echo
./bin/ed
./bin/egrep
./bin/false
./bin/fdflush
./bin/fgrep
./bin/fsync
./bin/getopt
./bin/grep
./bin/gunzip
./bin/gzip
./bin/hostname
./bin/hush
./bin/ionice
./bin/iostat
./bin/ip
./bin/ipaddr
./bin/ipcalc
./bin/iplink
./bin/iproute
./bin/iprule
./bin/iptunnel
./bin/kill
./bin/linux32
./bin/linux64
./bin/ln
./bin/login
./bin/ls
./bin/lsattr
./bin/lzop
./bin/makemime
./bin/mkdir
./bin/mknod
./bin/mktemp
./bin/more
./bin/mount
./bin/mountpoint
./bin/mpstat
./bin/mt
./bin/mv
./bin/netstat
./bin/nice
./bin/pidof
./bin/ping
./bin/ping6
./bin/pipe_progress
./bin/powertop
./bin/printenv
./bin/ps
./bin/pwd
./bin/reformime
./bin/rev
./bin/rm
./bin/rmdir
./bin/rpm
./bin/run-parts
./bin/scriptreplay
./bin/sed
./bin/setarch
./bin/setserial
./bin/sh
./bin/sleep
./bin/stat
./bin/stty
./bin/su
./bin/sync
./bin/tar
./bin/touch
./bin/true
./bin/umount
./bin/uname
./bin/usleep
./bin/vi
./bin/watch
./bin/zcat
./bin/busybox
./linuxrc
./sbin
./sbin/acpid
./sbin/adjtimex
./sbin/arp
./sbin/blkid
./sbin/blockdev
./sbin/bootchartd
./sbin/depmod
./sbin/devmem
./sbin/fbsplash
./sbin/fdisk
./sbin/findfs
./sbin/freeramdisk
./sbin/fsck
./sbin/fsck.minix
./sbin/getty
./sbin/halt
./sbin/hdparm
./sbin/hwclock
./sbin/ifconfig
./sbin/ifdown
./sbin/ifenslave
./sbin/ifup
./sbin/init
./sbin/insmod
./sbin/klogd
./sbin/loadkmap
./sbin/logread
./sbin/losetup
./sbin/lsmod
./sbin/makedevs
./sbin/man
./sbin/mdev
./sbin/mkdosfs
./sbin/mke2fs
./sbin/mkfs.ext2
./sbin/mkfs.minix
./sbin/mkfs.vfat
./sbin/mkswap
./sbin/modinfo
./sbin/modprobe
./sbin/nameif
./sbin/pivot_root
./sbin/poweroff
./sbin/raidautorun
./sbin/reboot
./sbin/rmmod
./sbin/route
./sbin/runlevel
./sbin/setconsole
./sbin/slattach
./sbin/start-stop-daemon
./sbin/sulogin
./sbin/swapoff
./sbin/swapon
./sbin/switch_root
./sbin/sysctl
./sbin/syslogd
./sbin/tunctl
./sbin/udhcpc
./sbin/vconfig
./sbin/watchdog
./sbin/zcip
./tmp
./tmp/reproducer
./usr
./usr/bin
./usr/bin/[
./usr/bin/[[
./usr/bin/add-shell
./usr/bin/arping
./usr/bin/awk
./usr/bin/basename
./usr/bin/beep
./usr/bin/bunzip2
./usr/bin/bzcat
./usr/bin/bzip2
./usr/bin/cal
./usr/bin/chat
./usr/bin/chpst
./usr/bin/chrt
./usr/bin/chvt
./usr/bin/cksum
./usr/bin/clear
./usr/bin/cmp
./usr/bin/comm
./usr/bin/crontab
./usr/bin/cryptpw
./usr/bin/cut
./usr/bin/dc
./usr/bin/deallocvt
./usr/bin/diff
./usr/bin/dirname
./usr/bin/dos2unix
./usr/bin/du
./usr/bin/dumpleases
./usr/bin/eject
./usr/bin/env
./usr/bin/envdir
./usr/bin/envuidgid
./usr/bin/ether-wake
./usr/bin/expand
./usr/bin/expr
./usr/bin/fdformat
./usr/bin/fgconsole
./usr/bin/find
./usr/bin/flock
./usr/bin/fold
./usr/bin/free
./usr/bin/ftpget
./usr/bin/ftpput
./usr/bin/fuser
./usr/bin/groups
./usr/bin/hd
./usr/bin/head
./usr/bin/hexdump
./usr/bin/hostid
./usr/bin/id
./usr/bin/ifplugd
./usr/bin/install
./usr/bin/ipcrm
./usr/bin/ipcs
./usr/bin/kbd_mode
./usr/bin/killall
./usr/bin/killall5
./usr/bin/last
./usr/bin/less
./usr/bin/logger
./usr/bin/logname
./usr/bin/lpq
./usr/bin/lpr
./usr/bin/lspci
./usr/bin/lsusb
./usr/bin/lzcat
./usr/bin/lzma
./usr/bin/lzopcat
./usr/bin/md5sum
./usr/bin/mesg
./usr/bin/microcom
./usr/bin/mkfifo
./usr/bin/mkpasswd
./usr/bin/nc
./usr/bin/nmeter
./usr/bin/nohup
./usr/bin/nslookup
./usr/bin/od
./usr/bin/openvt
./usr/bin/passwd
./usr/bin/patch
./usr/bin/pgrep
./usr/bin/pkill
./usr/bin/pmap
./usr/bin/printf
./usr/bin/pscan
./usr/bin/pstree
./usr/bin/pwdx
./usr/bin/readahead
./usr/bin/readlink
./usr/bin/realpath
./usr/bin/remove-shell
./usr/bin/renice
./usr/bin/reset
./usr/bin/resize
./usr/bin/rpm2cpio
./usr/bin/rtcwake
./usr/bin/runsv
./usr/bin/runsvdir
./usr/bin/rx
./usr/bin/script
./usr/bin/seq
./usr/bin/setkeycodes
./usr/bin/setsid
./usr/bin/setuidgid
./usr/bin/sha1sum
./usr/bin/sha256sum
./usr/bin/sha512sum
./usr/bin/showkey
./usr/bin/smemcap
./usr/bin/softlimit
./usr/bin/sort
./usr/bin/split
./usr/bin/strings
./usr/bin/sum
./usr/bin/sv
./usr/bin/tac
./usr/bin/tail
./usr/bin/tcpsvd
./usr/bin/tee
./usr/bin/telnet
./usr/bin/test
./usr/bin/tftp
./usr/bin/tftpd
./usr/bin/time
./usr/bin/timeout
./usr/bin/top
./usr/bin/tr
./usr/bin/traceroute
./usr/bin/traceroute6
./usr/bin/tty
./usr/bin/ttysize
./usr/bin/udpsvd
./usr/bin/unexpand
./usr/bin/uniq
./usr/bin/unix2dos
./usr/bin/unlzma
./usr/bin/unlzop
./usr/bin/unxz
./usr/bin/unzip
./usr/bin/uptime
./usr/bin/users
./usr/bin/uudecode
./usr/bin/uuencode
./usr/bin/vlock
./usr/bin/volname
./usr/bin/wall
./usr/bin/wc
./usr/bin/wget
./usr/bin/which
./usr/bin/who
./usr/bin/whoami
./usr/bin/whois
./usr/bin/xargs
./usr/bin/xz
./usr/bin/xzcat
./usr/bin/yes
./usr/sbin
./usr/sbin/brctl
./usr/sbin/chpasswd
./usr/sbin/chroot
./usr/sbin/crond
./usr/sbin/dhcprelay
./usr/sbin/dnsd
./usr/sbin/fakeidentd
./usr/sbin/fbset
./usr/sbin/ftpd
./usr/sbin/httpd
./usr/sbin/inetd
./usr/sbin/loadfont
./usr/sbin/lpd
./usr/sbin/nbd-client
./usr/sbin/ntpd
./usr/sbin/popmaildir
./usr/sbin/rdate
./usr/sbin/rdev
./usr/sbin/readprofile
./usr/sbin/sendmail
./usr/sbin/setfont
./usr/sbin/setlogcons
./usr/sbin/svlogd
./usr/sbin/telnetd
./usr/sbin/ubiattach
./usr/sbin/ubidetach
./usr/sbin/ubimkvol
./usr/sbin/ubirmvol
./usr/sbin/ubirsvol
./usr/sbin/ubiupdatevol
./usr/sbin/udhcpd
./etc
./proc
./sys
./init
4248 blocks
qemu-system-x86_64 \
	-smp 4 \
	-kernel linux/arch/x86/boot/bzImage \
	-initrd initramfs-busybox-x64.cpio.gz \
	-nographic \
 	-append console=ttyS0
[    0.000000] Linux version 4.15.0-rc2 (wmealing@linux.local) (gcc version 7.1.1 20170622 (Red Hat 7.1.1-3) (GCC)) #1 SMP Tue Jan 30 21:33:50 AEST 2018
[    0.000000] Command line: console=ttyS0
[    0.000000] x86/fpu: x87 FPU will use FXSAVE
[    0.000000] e820: BIOS-provided physical RAM map:
[    0.000000] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
[    0.000000] BIOS-e820: [mem 0x000000000009fc00-0x000000000009ffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000000f0000-0x00000000000fffff] reserved
[    0.000000] BIOS-e820: [mem 0x0000000000100000-0x0000000007fdffff] usable
[    0.000000] BIOS-e820: [mem 0x0000000007fe0000-0x0000000007ffffff] reserved
[    0.000000] BIOS-e820: [mem 0x00000000fffc0000-0x00000000ffffffff] reserved
[    0.000000] NX (Execute Disable) protection: active
[    0.000000] random: fast init done
[    0.000000] SMBIOS 2.8 present.
[    0.000000] DMI: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1.fc26 04/01/2014
[    0.000000] e820: last_pfn = 0x7fe0 max_arch_pfn = 0x400000000
[    0.000000] x86/PAT: Configuration [0-7]: WB  WC  UC- UC  WB  WP  UC- WT  
[    0.000000] found SMP MP-table at [mem 0x000f6be0-0x000f6bef] mapped at [        (ptrval)]
[    0.000000] Scanning 1 areas for low memory corruption
[    0.000000] RAMDISK: [mem 0x07ecf000-0x07fdffff]
[    0.000000] ACPI: Early table checksum verification disabled
[    0.000000] ACPI: RSDP 0x00000000000F6940 000014 (v00 BOCHS )
[    0.000000] ACPI: RSDT 0x0000000007FE1664 000030 (v01 BOCHS  BXPCRSDT 00000001 BXPC 00000001)
[    0.000000] ACPI: FACP 0x0000000007FE1528 000074 (v01 BOCHS  BXPCFACP 00000001 BXPC 00000001)
[    0.000000] ACPI: DSDT 0x0000000007FE0040 0014E8 (v01 BOCHS  BXPCDSDT 00000001 BXPC 00000001)
[    0.000000] ACPI: FACS 0x0000000007FE0000 000040
[    0.000000] ACPI: APIC 0x0000000007FE159C 000090 (v01 BOCHS  BXPCAPIC 00000001 BXPC 00000001)
[    0.000000] ACPI: HPET 0x0000000007FE162C 000038 (v01 BOCHS  BXPCHPET 00000001 BXPC 00000001)
[    0.000000] No NUMA configuration found
[    0.000000] Faking a node at [mem 0x0000000000000000-0x0000000007fdffff]
[    0.000000] NODE_DATA(0) allocated [mem 0x07ecb000-0x07ecefff]
[    0.000000] tsc: Fast TSC calibration using PIT
[    0.000000] Zone ranges:
[    0.000000]   DMA      [mem 0x0000000000001000-0x0000000000ffffff]
[    0.000000]   DMA32    [mem 0x0000000001000000-0x0000000007fdffff]
[    0.000000]   Normal   empty
[    0.000000] Movable zone start for each node
[    0.000000] Early memory node ranges
[    0.000000]   node   0: [mem 0x0000000000001000-0x000000000009efff]
[    0.000000]   node   0: [mem 0x0000000000100000-0x0000000007fdffff]
[    0.000000] Initmem setup node 0 [mem 0x0000000000001000-0x0000000007fdffff]
[    0.000000] Reserved but unavailable: 98 pages
[    0.000000] ACPI: PM-Timer IO Port: 0x608
[    0.000000] ACPI: LAPIC_NMI (acpi_id[0xff] dfl dfl lint[0x1])
[    0.000000] IOAPIC[0]: apic_id 0, version 32, address 0xfec00000, GSI 0-23
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 0 global_irq 2 dfl dfl)
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 5 global_irq 5 high level)
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 9 global_irq 9 high level)
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 10 global_irq 10 high level)
[    0.000000] ACPI: INT_SRC_OVR (bus 0 bus_irq 11 global_irq 11 high level)
[    0.000000] Using ACPI (MADT) for SMP configuration information
[    0.000000] ACPI: HPET id: 0x8086a201 base: 0xfed00000
[    0.000000] smpboot: Allowing 4 CPUs, 0 hotplug CPUs
[    0.000000] PM: Registered nosave memory: [mem 0x00000000-0x00000fff]
[    0.000000] PM: Registered nosave memory: [mem 0x0009f000-0x0009ffff]
[    0.000000] PM: Registered nosave memory: [mem 0x000a0000-0x000effff]
[    0.000000] PM: Registered nosave memory: [mem 0x000f0000-0x000fffff]
[    0.000000] e820: [mem 0x08000000-0xfffbffff] available for PCI devices
[    0.000000] clocksource: refined-jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1910969940391419 ns
[    0.000000] setup_percpu: NR_CPUS:64 nr_cpumask_bits:64 nr_cpu_ids:4 nr_node_ids:1
[    0.000000] percpu: Embedded 37 pages/cpu @        (ptrval) s110616 r8192 d32744 u524288
[    0.000000] Built 1 zonelists, mobility grouping on.  Total pages: 32105
[    0.000000] Policy zone: DMA32
[    0.000000] Kernel command line: console=ttyS0
[    0.000000] Memory: 105076K/130552K available (9332K kernel code, 1272K rwdata, 3012K rodata, 1168K init, 696K bss, 25476K reserved, 0K cma-reserved)
[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=4, Nodes=1
[    0.000000] Hierarchical RCU implementation.
[    0.000000] 	RCU event tracing is enabled.
[    0.000000] 	RCU restricting CPUs from NR_CPUS=64 to nr_cpu_ids=4.
[    0.000000] RCU: Adjusting geometry for rcu_fanout_leaf=16, nr_cpu_ids=4
[    0.000000] NR_IRQS: 4352, nr_irqs: 456, preallocated irqs: 16
[    0.000000] Console: colour VGA+ 80x25
[    0.000000] console [ttyS0] enabled
[    0.000000] ACPI: Core revision 20170831
[    0.000000] ACPI: 1 ACPI AML tables successfully acquired and loaded
[    0.000000] clocksource: hpet: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604467 ns
[    0.003000] APIC: Switch to symmetric I/O mode setup
[    0.006000] ..TIMER: vector=0x30 apic1=0 pin1=2 apic2=-1 pin2=-1
[    0.011000] tsc: Fast TSC calibration using PIT
[    0.012000] tsc: Detected 3066.583 MHz processor
[    0.014068] tsc: Marking TSC unstable due to TSCs unsynchronized
[    0.014356] Calibrating delay loop (skipped), value calculated using timer frequency.. 6133.16 BogoMIPS (lpj=3066583)
[    0.014796] pid_max: default: 32768 minimum: 301
[    0.016155] Security Framework initialized
[    0.016429] SELinux:  Initializing.
[    0.017600] Dentry cache hash table entries: 16384 (order: 5, 131072 bytes)
[    0.018077] Inode-cache hash table entries: 8192 (order: 4, 65536 bytes)
[    0.018454] Mount-cache hash table entries: 512 (order: 0, 4096 bytes)
[    0.018693] Mountpoint-cache hash table entries: 512 (order: 0, 4096 bytes)
[    0.035831] mce: CPU supports 10 MCE banks
[    0.037080] Last level iTLB entries: 4KB 0, 2MB 0, 4MB 0
[    0.037322] Last level dTLB entries: 4KB 0, 2MB 0, 4MB 0, 1GB 0
[    0.040514] Freeing SMP alternatives memory: 36K
[    0.052000] smpboot: CPU0: AMD QEMU Virtual CPU version 2.5+ (family: 0x6, model: 0x6, stepping: 0x3)
[    0.056495] Performance Events: PMU not available due to virtualization, using software events only.
[    0.057754] Hierarchical SRCU implementation.
[    0.063072] Huh? What family is it: 0x6?!
[    0.064339] smp: Bringing up secondary CPUs ...
[    0.067414] x86: Booting SMP configuration:
[    0.067578] .... node  #0, CPUs:      #1 #2 #3
[    0.297097] smp: Brought up 1 node, 4 CPUs
[    0.297476] smpboot: Max logical packages: 4
[    0.297749] smpboot: Total of 4 processors activated (31532.09 BogoMIPS)
[    0.316068] devtmpfs: initialized
[    0.332066] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 1911260446275000 ns
[    0.332963] futex hash table entries: 1024 (order: 4, 65536 bytes)
[    0.333000] kworker/u8:0 (30) used greatest stack depth: 14328 bytes left
[    0.334000] RTC time:  6:53:31, date: 01/31/18
[    0.334000] NET: Registered protocol family 16
[    0.337718] audit: initializing netlink subsys (disabled)
[    0.339399] audit: type=2000 audit(1517381610.338:1): state=initialized audit_enabled=0 res=1
[    0.357093] cpuidle: using governor menu
[    0.358780] ACPI: bus type PCI registered
[    0.362439] PCI: Using configuration type 1 for base access
[    0.369279] mtrr: your CPUs had inconsistent fixed MTRR settings
[    0.369805] mtrr: your CPUs had inconsistent variable MTRR settings
[    0.370033] mtrr: your CPUs had inconsistent MTRRdefType settings
[    0.370457] mtrr: probably your BIOS does not setup all CPUs.
[    0.370644] mtrr: corrected configuration.
[    0.545033] kworker/u8:6 (389) used greatest stack depth: 14272 bytes left
[    0.576484] HugeTLB registered 2.00 MiB page size, pre-allocated 0 pages
[    0.583088] ACPI: Added _OSI(Module Device)
[    0.583215] ACPI: Added _OSI(Processor Device)
[    0.583369] ACPI: Added _OSI(3.0 _SCP Extensions)
[    0.583521] ACPI: Added _OSI(Processor Aggregator Device)
[    0.610574] ACPI: Interpreter enabled
[    0.611760] ACPI: (supports S0 S3 S4 S5)
[    0.611944] ACPI: Using IOAPIC for interrupt routing
[    0.613090] PCI: Using host bridge windows from ACPI; if necessary, use "pci=nocrs" and report a bug
[    0.615991] ACPI: Enabled 2 GPEs in block 00 to 0F
[    0.705599] ACPI: PCI Root Bridge [PCI0] (domain 0000 [bus 00-ff])
[    0.706372] acpi PNP0A03:00: _OSC: OS supports [ASPM ClockPM Segments MSI]
[    0.707026] acpi PNP0A03:00: _OSC failed (AE_NOT_FOUND); disabling ASPM
[    0.707839] acpi PNP0A03:00: fail to add MMCONFIG information, can't access extended PCI configuration space under this bridge.
[    0.710812] PCI host bridge to bus 0000:00
[    0.711200] pci_bus 0000:00: root bus resource [io  0x0000-0x0cf7 window]
[    0.711494] pci_bus 0000:00: root bus resource [io  0x0d00-0xffff window]
[    0.711744] pci_bus 0000:00: root bus resource [mem 0x000a0000-0x000bffff window]
[    0.711983] pci_bus 0000:00: root bus resource [mem 0x08000000-0xfebfffff window]
[    0.712000] pci_bus 0000:00: root bus resource [bus 00-ff]
[    0.721076] pci 0000:00:01.1: legacy IDE quirk: reg 0x10: [io  0x01f0-0x01f7]
[    0.722052] pci 0000:00:01.1: legacy IDE quirk: reg 0x14: [io  0x03f6]
[    0.722346] pci 0000:00:01.1: legacy IDE quirk: reg 0x18: [io  0x0170-0x0177]
[    0.722743] pci 0000:00:01.1: legacy IDE quirk: reg 0x1c: [io  0x0376]
[    0.725858] pci 0000:00:01.3: quirk: [io  0x0600-0x063f] claimed by PIIX4 ACPI
[    0.727052] pci 0000:00:01.3: quirk: [io  0x0700-0x070f] claimed by PIIX4 SMB
[    0.753279] ACPI: PCI Interrupt Link [LNKA] (IRQs 5 *10 11)
[    0.755021] ACPI: PCI Interrupt Link [LNKB] (IRQs 5 *10 11)
[    0.756196] ACPI: PCI Interrupt Link [LNKC] (IRQs 5 10 *11)
[    0.757344] ACPI: PCI Interrupt Link [LNKD] (IRQs 5 10 *11)
[    0.758045] ACPI: PCI Interrupt Link [LNKS] (IRQs *9)
[    0.771000] pci 0000:00:02.0: vgaarb: setting as boot VGA device
[    0.771000] pci 0000:00:02.0: vgaarb: VGA device added: decodes=io+mem,owns=io+mem,locks=none
[    0.772070] pci 0000:00:02.0: vgaarb: bridge control possible
[    0.772109] vgaarb: loaded
[    0.774498] SCSI subsystem initialized
[    0.779895] ACPI: bus type USB registered
[    0.782122] usbcore: registered new interface driver usbfs
[    0.783475] usbcore: registered new interface driver hub
[    0.785026] usbcore: registered new device driver usb
[    0.786181] pps_core: LinuxPPS API ver. 1 registered
[    0.787493] pps_core: Software ver. 5.3.6 - Copyright 2005-2007 Rodolfo Giometti <giometti@linux.it>
[    0.789006] PTP clock support registered
[    0.791052] EDAC MC: Ver: 3.0.0
[    0.796170] Advanced Linux Sound Architecture Driver Initialized.
[    0.797289] PCI: Using ACPI for IRQ routing
[    0.808295] NetLabel: Initializing
[    0.808481] NetLabel:  domain hash size = 128
[    0.808633] NetLabel:  protocols = UNLABELED CIPSOv4 CALIPSO
[    0.810375] NetLabel:  unlabeled traffic allowed by default
[    0.812481] HPET: 3 timers in total, 0 timers will be used for per-cpu timer
[    0.813261] hpet0: at MMIO 0xfed00000, IRQs 2, 8, 0
[    0.813726] hpet0: 3 comparators, 64-bit 100.000000 MHz counter
[    0.818520] clocksource: Switched to clocksource hpet
[    1.034817] VFS: Disk quotas dquot_6.6.0
[    1.035497] VFS: Dquot-cache hash table entries: 512 (order 0, 4096 bytes)
[    1.038903] pnp: PnP ACPI init
[    1.049449] pnp: PnP ACPI: found 6 devices
[    1.136981] clocksource: acpi_pm: mask: 0xffffff max_cycles: 0xffffff, max_idle_ns: 2085701024 ns
[    1.139325] NET: Registered protocol family 2
[    1.145442] TCP established hash table entries: 1024 (order: 1, 8192 bytes)
[    1.145870] TCP bind hash table entries: 1024 (order: 2, 16384 bytes)
[    1.146155] TCP: Hash tables configured (established 1024 bind 1024)
[    1.147648] UDP hash table entries: 256 (order: 1, 8192 bytes)
[    1.147999] UDP-Lite hash table entries: 256 (order: 1, 8192 bytes)
[    1.149911] NET: Registered protocol family 1
[    1.152665] RPC: Registered named UNIX socket transport module.
[    1.153597] RPC: Registered udp transport module.
[    1.153766] RPC: Registered tcp transport module.
[    1.153923] RPC: Registered tcp NFSv4.1 backchannel transport module.
[    1.156783] pci 0000:00:00.0: Limiting direct PCI/PCI transfers
[    1.157399] pci 0000:00:01.0: PIIX3: Enabling Passive Release
[    1.157721] pci 0000:00:01.0: Activating ISA DMA hang workarounds
[    1.158336] pci 0000:00:02.0: Video device with shadowed ROM at [mem 0x000c0000-0x000dffff]
[    1.163802] Unpacking initramfs...
[    1.294169] Freeing initrd memory: 1092K
[    1.295703] clocksource: tsc: mask: 0xffffffffffffffff max_cycles: 0x2c33f7e50c8, max_idle_ns: 440795350559 ns
[    1.308690] Scanning for low memory corruption every 60 seconds
[    1.327961] Initialise system trusted keyrings
[    1.330676] workingset: timestamp_bits=56 max_order=15 bucket_order=0
[    1.397737] NFS: Registering the id_resolver key type
[    1.398279] Key type id_resolver registered
[    1.398429] Key type id_legacy registered
[    1.433502] Key type asymmetric registered
[    1.433706] Asymmetric key parser 'x509' registered
[    1.434669] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 250)
[    1.435033] io scheduler noop registered
[    1.435806] io scheduler deadline registered
[    1.437027] io scheduler cfq registered (default)
[    1.438235] io scheduler mq-deadline registered
[    1.438400] io scheduler kyber registered
[    1.445003] input: Power Button as /devices/LNXSYSTM:00/LNXPWRBN:00/input/input0
[    1.448545] ACPI: Power Button [PWRF]
[    1.463819] Serial: 8250/16550 driver, 4 ports, IRQ sharing enabled
[    1.487363] 00:05: ttyS0 at I/O 0x3f8 (irq = 4, base_baud = 115200) is a 16550A
[    1.503655] Non-volatile memory driver v1.3
[    1.505724] Linux agpgart interface v0.103
[    1.559274] loop: module loaded
[    1.579425] scsi host0: ata_piix
[    1.583753] scsi host1: ata_piix
[    1.584996] ata1: PATA max MWDMA2 cmd 0x1f0 ctl 0x3f6 bmdma 0xc040 irq 14
[    1.585958] ata2: PATA max MWDMA2 cmd 0x170 ctl 0x376 bmdma 0xc048 irq 15
[    1.589043] e100: Intel(R) PRO/100 Network Driver, 3.5.24-k2-NAPI
[    1.590804] e100: Copyright(c) 1999-2006 Intel Corporation
[    1.591459] e1000: Intel(R) PRO/1000 Network Driver - version 7.3.21-k8-NAPI
[    1.591696] e1000: Copyright (c) 1999-2006 Intel Corporation.
[    1.788999] ata2.00: ATAPI: QEMU DVD-ROM, 2.5+, max UDMA/100
[    1.810548] ata2.00: configured for MWDMA2
[    1.841610] scsi 1:0:0:0: CD-ROM            QEMU     QEMU DVD-ROM     2.5+ PQ: 0 ANSI: 5
[    1.898448] sr 1:0:0:0: [sr0] scsi3-mmc drive: 4x/4x cd/rw xa/form2 tray
[    1.898843] cdrom: Uniform CD-ROM driver Revision: 3.20
[    1.917477] sr 1:0:0:0: Attached scsi generic sg0 type 5
[    2.015244] ACPI: PCI Interrupt Link [LNKC] enabled at IRQ 11
[    2.314012] e1000 0000:00:03.0 eth0: (PCI:33MHz:32-bit) 52:54:00:12:34:56
[    2.315881] e1000 0000:00:03.0 eth0: Intel(R) PRO/1000 Network Connection
[    2.316820] e1000e: Intel(R) PRO/1000 Network Driver - 3.2.6-k
[    2.316994] e1000e: Copyright(c) 1999 - 2015 Intel Corporation.
[    2.318559] sky2: driver version 1.30
[    2.323659] ehci_hcd: USB 2.0 'Enhanced' Host Controller (EHCI) Driver
[    2.323894] ehci-pci: EHCI PCI platform driver
[    2.324648] ohci_hcd: USB 1.1 'Open' Host Controller (OHCI) Driver
[    2.324915] ohci-pci: OHCI PCI platform driver
[    2.325935] uhci_hcd: USB Universal Host Controller Interface driver
[    2.327685] usbcore: registered new interface driver usblp
[    2.328771] usbcore: registered new interface driver usb-storage
[    2.330807] i8042: PNP: PS/2 Controller [PNP0303:KBD,PNP0f13:MOU] at 0x60,0x64 irq 1,12
[    2.336582] serio: i8042 KBD port at 0x60,0x64 irq 1
[    2.336923] serio: i8042 AUX port at 0x60,0x64 irq 12
[    2.344692] rtc_cmos 00:00: RTC can wake from S4
[    2.349760] rtc_cmos 00:00: rtc core: registered rtc_cmos as rtc0
[    2.351641] input: AT Translated Set 2 keyboard as /devices/platform/i8042/serio0/input/input1
[    2.352347] rtc_cmos 00:00: alarms up to one day, y3k, 114 bytes nvram, hpet irqs
[    2.363769] device-mapper: ioctl: 4.37.0-ioctl (2017-09-20) initialised: dm-devel@redhat.com
[    2.365670] hidraw: raw HID events driver (C) Jiri Kosina
[    2.377786] usbcore: registered new interface driver usbhid
[    2.377990] usbhid: USB HID core driver
[    2.382264] playground: initialized
[    2.384622] Module successfully loaded
[    2.386552] CHRDEV "vuln" major requested (700) is greater than the maximum (512)
[    2.387004] slub Registring device vulnn
[    2.388811] Module successfully loaded
[    2.390616] Module successfully loaded
[    2.390756] Kstack proc loading up
[    2.390999] mock buggy futex: loading module
[    2.391640] created /proc/stack_buffer_overflow
[    2.398997] Netfilter messages via NETLINK v0.30.
[    2.401448] nf_conntrack version 0.5.0 (1024 buckets, 4096 max)
[    2.402982] ctnetlink v0.93: registering with nfnetlink.
[    2.406816] ip_tables: (C) 2000-2006 Netfilter Core Team
[    2.413954] Initializing XFRM netlink socket
[    2.419023] NET: Registered protocol family 10
[    2.428459] Segment Routing with IPv6
[    2.430582] ip6_tables: (C) 2000-2006 Netfilter Core Team
[    2.434799] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver
[    2.439521] NET: Registered protocol family 17
[    2.440469] Key type dns_resolver registered
[    2.449790] registered taskstats version 1
[    2.449954] Loading compiled-in X.509 certificates
[    2.454040]   Magic number: 2:273:874
[    2.454931] console [netcon0] enabled
[    2.455216] netconsole: network logging started
[    2.458479] cfg80211: Loading compiled-in X.509 certificates for regulatory database
[    2.519386] cfg80211: Loaded X.509 cert 'sforshee: 00b28ddf47aef9cea7'
[    2.520949] platform regulatory.0: Direct firmware load for regulatory.db failed with error -2
[    2.521656] cfg80211: failed to load regulatory.db
[    2.522737] ALSA device list:
[    2.522878]   No soundcards found.
[    2.586411] Freeing unused kernel memory: 1168K
[    2.586657] Write protecting the kernel read-only data: 14336k
[    2.590583] Freeing unused kernel memory: 876K
[    2.614766] Freeing unused kernel memory: 1084K
[    3.055725] input: ImExPS/2 Generic Explorer Mouse as /devices/platform/i8042/serio1/input/input3
Boot took 2.69 seconds

[+] running!
[!] no panic?

$ exit
[   4.632038] sh (1043) used greatest stack depth: 14200 bytes left
[   4.053487] ACPI: Preparing to enter system sleep state S5
[   46.055168] reboot: Power down

```

To have it execute your own exploit based on the template:

```
cp -rf TEMPLATE-EXPLOIT/ CHALLENGE-1
make CHALLENGE=CHALLENGE-1
```





### Kernel symbols
Once we have managed to cause some memory corruption that we can control, we usually need to know where some of the symbols (pointers to functions, fields, structures, etc..) are located in memory.  There exists a kernel proc entry which lists all of the symbols and their locations.  This information can be read from userspace from the file located at ```/proc/kallsyms```. There is a proc interface kallsyms which names the exported kernel symbol as well as the address at which it is located. 

In recent kernel versions, in order to make exploitation of kernel bugs more difficult, the kernel has restricted these symbols for viewing only by those with CAP_SYS_ADMIN privledeges.  You can read the semantics of kptr_restrict submitted by Dan Rosenberg, et al. [here](http://lwn.net/Articles/420403/).

Reading kallsyms with kptr restrict enabled:

 ```
 cat /proc/kallsyms | grep commit_creds
 00000000 T commit_creds
 ```
 
 In order for this exploit to resolve symbols, you need to modify the initramfs/init file, you can do this before the reproducer is run (via /tmp/reproducer) or before the interactive shell starts ( via setsid setuidgid 1000 cttyhack /bin/sh )

 ````
   echo 0 > /proc/sys/kernel/kptr_restrict
 ```

 And now we can properly see the kernel symbols and their addresses:
 ```
 cat /proc/kallsyms | grep commit_creds
 c008e138 T commit_creds
 ```

We will make the assumption that we know the location of all kernel symbols. While this not strictly true in practice, it is fairly safe to assume that we will be able to access to kernel symbols one way or another.  Locations of items in memory change with every compilation of the kernel.  OEMs build a kernel for each device/product and that kernel is used across all instances of that device (the kernel can change with sytem upgrades, different regions of the phone, small hardware changes in same device).  If you can obtain the OTA update, factory image, etc for the device, you can extract the necessary symbols in a static manner.  Also, if you are able to obtain root on the device in some other manner (unlocked bootloaders, an 0-day you are holding, etc), you can use that to bootsrap yourself to get the necessary symbols




